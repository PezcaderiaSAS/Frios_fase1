<script>
    // ======================================================
    // 1. CONFIGURACIÓN DEL ROUTER (SPA)
    // ======================================================
    const Router = {
        'view-dashboard': initDashboard,
        'view-products': initProducts,
        'view-clients': initClients,
        'view-entrada': initEntrada,
        'view-salida': initSalida,
        'view-movements': initMovimientos,
        'view-billing': initBilling
    };

    const GLOBAL_STATE = {
        clientes: [],
        productos: []
    };

    // ======================================================
    // 2. MOTOR DE NAVEGACIÓN Y UTILIDAD PROMISE
    // ======================================================

    /**
     * Wrapper para convertir google.script.run en Promesas
     */
    function serverCall(funcName, ...args) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
            [funcName](...args);
        });
    }

    async function loadView(viewName) {
        if (!viewName) return;
        const app = document.getElementById('app');

        app.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center" style="height: 60vh;">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div class="text-muted fw-bold">Cargando módulo...</div>
        </div>`;

        try {
            const htmlContent = await serverCall('getHtmlContent', viewName);
            app.innerHTML = htmlContent;

            if (Router[viewName]) {
                console.log('Iniciando lógica:', viewName);
                await Router[viewName]();
            }
        } catch (err) {
            console.error(err);
            app.innerHTML = `<div class="alert alert-danger m-4">Error cargando vista: ${err.message}</div>`;
        }
    }

    // ======================================================
    // 3. LOGICA MAESTRA (CONTROLLERS)
    // ======================================================

    // --- PRODUCTOS ---
    // --- PRODUCTOS ---
    // --- PRODUCTOS ---
    async function initProducts() {
        const tbody = document.getElementById('products-table-body');
        const loader = document.getElementById('loading-products');
        const container = document.getElementById('products-container');
        const btnRefresh = document.getElementById('btn-refresh-products');
        const btnReportStock = document.getElementById('btn-report-stock');
        const btnSort = document.getElementById('btn-sort-weight');
        const filterCli = document.getElementById('filter-products-client');

        // Cargar Clientes para Filtro
        try {
            const clientes = await serverCall('apiGetClientes');
            let opts = '<option value="">Todos los Clientes</option>';
            clientes.forEach(c => opts += `<option value="${c.id}">${c.nombre}</option>`);

            if (filterCli) {
                const current = filterCli.value;
                filterCli.innerHTML = opts;
                if (current) filterCli.value = current;
            }

            // CHECK EDIT MODE
            if (GLOBAL_STATE.tempEditData && GLOBAL_STATE.tempEditData.header.tipo === 'ENTRADA') {
                setupEditEntradaMode(GLOBAL_STATE.tempEditData);
                // Consume data immediately or keep it?
                // Better keep it until cancel/save, but setupEdit... expects it.
            }
        } catch (e) {
            alert("Error cargando clientes: " + e.message);
        }

        function renderTable(data) {
            let html = '';
            if (!data || data.length === 0) html = '<tr><td colspan="6" class="text-center text-muted py-4">Sin datos</td></tr>';
            else {
                data.forEach(p => {
                    const badge = p.stockPeso > 0 ? 'bg-primary-subtle text-primary' : 'bg-light text-muted';
                    html += `<tr>
                      <td class="ps-4 font-monospace small text-muted">${p.id}</td>
                      <td class="fw-bold text-dark">${p.nombre}</td>
                      <td><span class="badge bg-light text-dark border fw-normal">${p.idCliente}</span></td>
                      <td>${p.empaque} <span class="small text-muted">(${p.pesoNominal}kg)</span></td>
                      <td class="text-end font-monospace">${p.stockCajas}</td>
                      <td class="text-end pe-4"><span class="badge ${badge} fs-6">${p.stockPeso}</span></td>
                      <td class="text-end pe-3">
                          <button class="btn btn-sm btn-light border" onclick="openEditProduct('${p.id}')" title="Editar">
                            <i class="fas fa-pencil-alt text-secondary"></i>
                          </button>
                      </td>
                  </tr>`;
                });
            }
            tbody.innerHTML = html;
        }

        async function loadData() {
            const idCliente = filterCli.value;
            loader.classList.remove('d-none');
            container.classList.add('d-none');

            try {
                const data = await serverCall('apiGetProductosConStock', idCliente);
                GLOBAL_STATE.productos = data;
                // Nota: El backend ya devuelve ordenado por peso, pero renderTable lo pinta directo.
                renderTable(data);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${e.message}</td></tr>`;
            } finally {
                loader.classList.add('d-none');
                container.classList.remove('d-none');
            }
        }

        // --- EDIT PRODUCT LOGIC ---
        const modalEditEl = document.getElementById('modal-product-edit');
        const modalEdit = new bootstrap.Modal(modalEditEl);
        const btnUpdate = document.getElementById('btn-update-product');

        // Exponer función globalmente para el onclick
        window.openEditProduct = (id) => {
            const prod = GLOBAL_STATE.productos.find(p => p.id === id);
            if (!prod) return;

            document.getElementById('edit-prod-id').value = prod.id;
            document.getElementById('edit-prod-nombre').value = prod.nombre;
            document.getElementById('edit-prod-peso').value = prod.pesoNominal;
            document.getElementById('edit-prod-empaque').value = prod.empaque;

            modalEdit.show();
        };

        if (btnUpdate) {
            btnUpdate.onclick = async () => {
                const id = document.getElementById('edit-prod-id').value;
                const nombre = document.getElementById('edit-prod-nombre').value.trim();
                const peso = parseFloat(document.getElementById('edit-prod-peso').value);
                const empaque = document.getElementById('edit-prod-empaque').value;

                // Necesitamos el idCliente (buscamos en global state)
                const currentProd = GLOBAL_STATE.productos.find(p => p.id === id);
                if (!currentProd) return alert("Error de consistencia.");

                if (nombre.length < 3) return alert("Nombre muy corto.");
                if (isNaN(peso) || peso <= 0) return alert("Peso inválido.");

                const payload = {
                    id: id,
                    idCliente: currentProd.idCliente,
                    nombre: nombre,
                    pesoNominal: peso,
                    empaque: empaque
                };

                const originalText = btnUpdate.innerHTML;
                btnUpdate.disabled = true;
                btnUpdate.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

                try {
                    const res = await serverCall('apiActualizarProducto', payload);
                    if (res.success) {
                        alert("Producto actualizado.");
                        modalEdit.hide();
                        loadData();
                    } else {
                        alert("Error: " + res.error);
                    }
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    btnUpdate.disabled = false;
                    btnUpdate.innerHTML = originalText;
                }
            };
        }

        if (btnRefresh) btnRefresh.onclick = loadData;
        if (filterCli) filterCli.onchange = loadData;
        if (btnSort) {
            btnSort.onclick = () => {
                if (!GLOBAL_STATE.productos || GLOBAL_STATE.productos.length === 0) return;
                // Ordenar GLOBAL_STATE y re-renderizar
                GLOBAL_STATE.productos.sort((a, b) => (parseFloat(b.stockPeso) || 0) - (parseFloat(a.stockPeso) || 0));
                renderTable(GLOBAL_STATE.productos);
                // Feedback visual simple
                const icon = btnSort.querySelector('i');
                icon.className = 'fas fa-check text-success me-2';
                setTimeout(() => icon.className = 'fas fa-sort-amount-down me-2', 1000);
            };
        }

        if (btnReportStock) {
            btnReportStock.onclick = async () => {
                const idCliente = filterCli.value;
                if (!idCliente) return alert("Por favor seleccione un cliente para generar el reporte.");

                const originalText = btnReportStock.innerHTML;
                btnReportStock.disabled = true;
                btnReportStock.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

                try {
                    const res = await serverCall('apiGenerarReporteStock', idCliente);
                    if (res.success && res.pdfUrl) {
                        window.open(res.pdfUrl, '_blank');
                    } else {
                        alert("Error generando reporte: " + (res.error || "Desconocido"));
                    }
                } catch (e) {
                    alert("Error de conexión: " + e.message);
                } finally {
                    btnReportStock.disabled = false;
                    btnReportStock.innerHTML = originalText;
                }
            };
        }

        // --- NUEVO PRODUCTO MASIVO LOGIC ---
        const btnNew = document.getElementById('btn-new-product');
        const modalEl = document.getElementById('modal-product');
        const modal = new bootstrap.Modal(modalEl);
        const btnSave = document.getElementById('btn-save-product');
        const btnAddRow = document.getElementById('btn-add-row');
        const tbodyBatch = document.getElementById('tbody-batch-products');

        // Helpers de Tabla
        const createRow = () => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="form-control form-control-sm inp-name" placeholder="Nombre..."></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm inp-weight" placeholder="0.00"></td>
                <td>
                    <select class="form-select form-select-sm inp-pack">
                        <option value="Caja">Caja</option>
                        <option value="Bulto">Bulto</option>
                        <option value="Unidad">Unidad</option>
                        <option value="Pallet">Pallet</option>
                    </select>
                </td>
                <td class="text-center"><button class="btn btn-sm btn-link text-danger p-0 btn-del"><i class="fas fa-trash"></i></button></td>
             `;
            tr.querySelector('.btn-del').onclick = () => {
                if (tbodyBatch.children.length > 1) tr.remove();
                else {
                    tr.querySelectorAll('input').forEach(i => i.value = ''); // Si es la ultima, solo limpiar
                }
            };
            return tr;
        };

        if (btnNew) {
            btnNew.onclick = async () => {
                // 1. Cargar Clientes
                const selModal = document.getElementById('prod-cliente');
                try {
                    const clientes = GLOBAL_STATE.clientes || await serverCall('apiGetClientes');
                    let opts = '<option value="" disabled selected>Seleccione...</option>';
                    clientes.forEach(c => opts += `<option value="${c.id}">${c.nombre}</option>`);
                    selModal.innerHTML = opts;

                    // 2. Pre-seleccionar filtro
                    const currentFilter = filterCli.value;
                    selModal.value = currentFilter || "";
                    selModal.disabled = false; // Siempre editable salvo requerimiento estricto

                    // 3. Reset Tabla
                    tbodyBatch.innerHTML = '';
                    tbodyBatch.appendChild(createRow()); // Fila inicial

                    modal.show();
                } catch (e) {
                    alert("Error inicializando: " + e.message);
                }
            };
        }

        if (btnAddRow) {
            btnAddRow.onclick = () => tbodyBatch.appendChild(createRow());
        }

        if (btnSave) {
            btnSave.onclick = async () => {
                const idCliente = document.getElementById('prod-cliente').value;
                if (!idCliente) return alert("Debe seleccionar un cliente propietario.");

                // Recolectar datos
                const products = [];
                let error = null;

                tbodyBatch.querySelectorAll('tr').forEach((tr, idx) => {
                    const nombre = tr.querySelector('.inp-name').value.trim();
                    const peso = parseFloat(tr.querySelector('.inp-weight').value);
                    const empaque = tr.querySelector('.inp-pack').value;

                    // Ignorar filas vacías si hay otras válidas, pero si es la única y está vacía alertar
                    if (!nombre && isNaN(peso)) return;

                    if (nombre.length < 3) error = `Fila ${idx + 1}: Nombre muy corto.`;
                    if (isNaN(peso) || peso <= 0) error = `Fila ${idx + 1}: Peso inválido.`;

                    products.push({ nombre, pesoNominal: peso, empaque });
                });

                if (error) return alert(error);
                if (products.length === 0) return alert("Ingrese al menos un producto.");

                // Enviar
                const originalText = btnSave.innerHTML;
                btnSave.disabled = true;
                btnSave.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

                try {
                    const res = await serverCall('apiGuardarProductosBatch', products, idCliente);
                    if (res.success) {
                        alert(`✅ ${products.length} Productos creados exitosamente.`);
                        modal.hide();
                        // Refrescar si el filtro coincide
                        if (!filterCli.value || filterCli.value === idCliente) loadData();
                    } else {
                        alert("Error: " + res.error);
                    }
                } catch (e) {
                    alert("Error de conexión: " + e.message);
                } finally {
                    btnSave.disabled = false;
                    btnSave.innerHTML = originalText;
                }
            };
        }

        loadData();
    }

    // --- DASHBOARD ---
    async function initDashboard() {
        const select = document.getElementById('dash-select-cliente');
        const loader = document.getElementById('dash-loading');
        const content = document.getElementById('dash-content');
        const empty = document.getElementById('dash-empty');

        try {
            const clientes = await serverCall('apiGetClientes');
            GLOBAL_STATE.clientes = clientes;
            let opts = '<option value="" disabled selected>Seleccione Cliente...</option>';
            clientes.forEach(c => opts += `<option value="${c.id}">${c.nombre}</option>`);
            select.innerHTML = opts;

            const saved = sessionStorage.getItem('dashboardCliente');
            if (saved) { select.value = saved; loadData(saved); }
        } catch (e) {
            alert("Error cargando clientes: " + e.message);
        }

        select.onchange = () => {
            const id = select.value;
            sessionStorage.setItem('dashboardCliente', id);
            loadData(id);
        };

        async function loadData(id) {
            loader.classList.remove('d-none');
            content.classList.add('d-none');
            empty.classList.add('d-none');

            try {
                const res = await serverCall('apiGetDashboardData', id);
                loader.classList.add('d-none');

                if (res.success) {
                    const pct = res.ocupacion.porcentaje;
                    const elPct = document.getElementById('dash-porcentaje');

                    // Prevention of Race Condition: If view changed, stop.
                    if (!elPct) return;

                    const elRing = elPct.parentElement.parentElement;
                    const numTotal = document.getElementById('dash-peso-total');

                    // Reset Classes
                    elPct.className = 'display-4 fw-bold mb-0 lh-1';
                    elRing.className = 'position-relative d-inline-flex align-items-center justify-content-center rounded-circle';

                    // Color Logic
                    let colorClass = 'text-primary';
                    let ringClass = 'bg-light';

                    if (pct >= 100) {
                        colorClass = 'text-danger';
                        ringClass = 'bg-danger-subtle text-danger';
                    } else if (pct >= 80) {
                        colorClass = 'text-warning';
                        ringClass = 'bg-warning-subtle text-warning-emphasis';
                    } else {
                        colorClass = 'text-success'; // Positive vibe
                        ringClass = 'bg-success-subtle text-success';
                    }

                    numTotal.className = `display-4 fw-bold ${colorClass} mb-0 lh-1`;
                    elRing.className = `${ringClass} position-relative d-inline-flex align-items-center justify-content-center rounded-circle`;
                    elPct.className = `fw-bold ${colorClass}`; // Inner text

                    document.getElementById('dash-peso-total').textContent = res.ocupacion.pesoTotal.toFixed(0);
                    document.getElementById('dash-porcentaje').textContent = pct.toFixed(0);
                    document.getElementById('dash-pos-usadas').textContent = res.ocupacion.posicionesUsadas.toFixed(1);
                    document.getElementById('dash-pos-contrato').textContent = res.contrato.posiciones;

                    // Alert check
                    const alertElem = document.getElementById('dash-alert-exceso'); // Renamed variable locally to avoid conflict
                    if (pct >= 100) {
                        alertElem.classList.remove('d-none');
                        alertElem.classList.add('d-flex');
                        document.getElementById('dash-exceso-msg').textContent = `Uso actual: ${pct.toFixed(1)}%. Se aplicará tarifa de excedente.`;
                    } else {
                        alertElem.classList.add('d-none');
                        alertElem.classList.remove('d-flex');
                    }

                    const tbody = document.getElementById('dash-historial-body');
                    let html = '';
                    res.historial.forEach(m => {
                        const badge = m.tipo === 'ENTRADA' ? 'bg-success-subtle text-success' : 'bg-warning-subtle text-warning';
                        html += `<tr>
                          <td class="ps-4"><span class="badge rounded-pill fw-bold ${badge}">${m.tipo.charAt(0)}</span></td>
                          <td><div class="fw-bold small">${m.ref || 'N/A'}</div></td>
                          <td class="text-xs text-secondary">${new Date(m.fecha).toLocaleDateString()}</td>
                          <td class="text-end fw-bold pe-4">${m.totalPeso} kg</td>
                          <td class="text-end"><a href="${m.url}" target="_blank" class="btn btn-sm btn-icon btn-light rounded-circle"><i class="fas fa-file-pdf"></i></a></td>
                      </tr>`;
                    });
                    tbody.innerHTML = html;
                    content.classList.remove('d-none');
                } else {
                    alert(res.error);
                }
            } catch (e) {
                alert("Error obteniendo datos: " + e.message);
                loader.classList.add('d-none');
            }
        }
    }

    // --- CLIENTES ---
    // --- CLIENTES ---
    async function initClients() {
        const tbody = document.getElementById('clients-table-body');
        const btnNew = document.getElementById('btn-nuevo-cliente');

        try {
            const clientes = await serverCall('apiGetClientes');
            GLOBAL_STATE.clientes = clientes;
            let html = '';
            clientes.forEach(c => {
                const tag = c.contratoInfo ? `<span class="badge bg-info-subtle text-info-emphasis">${c.contratoInfo.posiciones} Pos.</span>` : `<span class="badge bg-secondary-subtle">Sin Contrato</span>`;
                html += `<tr>
                <td class="ps-4"><div class="fw-bold text-dark">${c.nombre}</div><small class="text-muted">${c.nit}</small></td>
                <td>${tag}</td>
                <td class="small">${c.telefono || '-'}</td>
                <td class="text-end pe-4"><button class="btn btn-sm btn-light border btn-edit" data-id="${c.id}">Editar</button></td>
            </tr>`;
            });
            tbody.innerHTML = html;

            document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => loadEdit(b.dataset.id));
        } catch (e) {
            alert("Error cargando clientes: " + e.message);
        }

        btnNew.onclick = () => {
            document.getElementById('form-cliente').reset();
            document.getElementById('cli-id').value = '';
            document.getElementById('btn-cancel-edit').classList.add('d-none');
            document.getElementById('form-client-title').textContent = 'Nuevo Cliente';
        };

        const selectTipo = document.getElementById('cli-tipoPago');
        const fieldPrecio = document.getElementById('field-precio-dia');
        if (selectTipo) selectTipo.onchange = () => {
            if (selectTipo.value === 'POSTPAGO') fieldPrecio.classList.remove('d-none');
            else fieldPrecio.classList.add('d-none');
        };

        document.getElementById('form-cliente').onsubmit = async (e) => {
            e.preventDefault();
            const form = {
                id: document.getElementById('cli-id').value,
                nombre: document.getElementById('cli-nombre').value,
                nit: document.getElementById('cli-nit').value,
                telefono: document.getElementById('cli-telefono').value,
                posiciones: document.getElementById('cli-posiciones').value,
                tipoPago: document.getElementById('cli-tipoPago').value,
                precioPosicion: document.getElementById('cli-precio').value,
                precioExceso: document.getElementById('cli-exceso').value,
                precioDiaPosicion: document.getElementById('cli-precioDia').value
            };
            const method = form.id ? 'apiActualizarCliente' : 'apiGuardarCliente';

            try {
                const res = await serverCall(method, form);
                alert(res.message);
                if (res.success) { initClients(); btnNew.click(); }
            } catch (err) {
                alert("Error guardando cliente: " + err.message);
            }
        };

        function loadEdit(id) {
            const c = GLOBAL_STATE.clientes.find(x => x.id === id);
            if (c) {
                document.getElementById('cli-id').value = c.id;
                document.getElementById('cli-nombre').value = c.nombre;
                document.getElementById('cli-nit').value = c.nit;
                document.getElementById('cli-telefono').value = c.telefono;
                if (c.contratoInfo) {
                    document.getElementById('cli-posiciones').value = c.contratoInfo.posiciones;
                    document.getElementById('cli-precio').value = c.contratoInfo.precio;
                    document.getElementById('cli-exceso').value = c.contratoInfo.exceso;
                    document.getElementById('cli-tipoPago').value = c.contratoInfo.tipoPago || 'PREPAGO';
                    document.getElementById('cli-precioDia').value = c.contratoInfo.precioDiaPosicion || 0;
                    if (selectTipo) selectTipo.onchange();
                }
                document.getElementById('form-client-title').textContent = 'Editar Cliente';
                const btnCancel = document.getElementById('btn-cancel-edit');
                btnCancel.classList.remove('d-none');
                btnCancel.onclick = btnNew.onclick;
            }
        }
    }

    // --- VISTA: ENTRADA ---
    // --- VISTA: ENTRADA ---
    async function initEntrada() {
        const tbody = document.getElementById('entrada-tbody');
        const selectCli = document.getElementById('entrada-cliente');
        const btnAdd = document.getElementById('entrada-btn-add');
        const btnSave = document.getElementById('entrada-btn-save');

        try {
            const res = await serverCall('apiGetDataInicial');
            GLOBAL_STATE.clientes = res.clientes;
            GLOBAL_STATE.productos = res.productos;
            let opts = '<option value="" disabled selected>Seleccione...</option>';
            res.clientes.forEach(c => opts += `<option value="${c.id}">${c.nombre}</option>`);
            selectCli.innerHTML = opts;

            document.getElementById('entrada-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('entrada-fecha-hoy').textContent = new Date().toLocaleDateString();

            // Default Frozen Check REMOVED (Now per item)
            // if (document.getElementById('entrada-congelado')) document.getElementById('entrada-congelado').checked = true;

            // CHECK EDIT MODE
            // CHECK EDIT MODE
            if (GLOBAL_STATE.tempEditData && GLOBAL_STATE.tempEditData.header.tipo === 'ENTRADA') {
                if (typeof loadEditEntrada === 'function') loadEditEntrada(GLOBAL_STATE.tempEditData);
            } else {
                addItemRow();
                btnAdd.onclick = addItemRow;
                btnSave.onclick = saveEntrada;
            }
        } catch (e) {
            showToast("Error cargando datos iniciales: " + e.message, 'danger');
        }

        // --- NUEVO: LISTENER DE CAMBIO DE CLIENTE ---
        selectCli.onchange = () => {
            // Limpiar tabla al cambiar cliente
            tbody.innerHTML = '';
            // Agregar fila vacía (ahora filtrará por el nuevo cliente)
            addItemRow();
        };

        function addItemRow() {
            const idClienteActual = selectCli.value;
            const tr = document.createElement('tr');

            let prodOpts = '<option value="" disabled selected>Seleccione...</option>';

            if (idClienteActual) {
                // FILTRAR PRODUCTOS POR CLIENTE
                const productosFiltrados = GLOBAL_STATE.productos.filter(p => String(p.idCliente) === String(idClienteActual));

                if (productosFiltrados.length === 0) {
                    prodOpts = '<option value="" disabled selected>Sin productos registrados</option>';
                } else {
                    productosFiltrados.forEach(p => prodOpts += `<option value="${p.id}" data-weight="${p.pesoNominal}">${p.nombre} (${p.empaque})</option>`);
                }
            } else {
                prodOpts = '<option value="" disabled selected>Seleccione Cliente Primero</option>';
            }

            // Calc Vencimiento (+1 Mes Default)
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            const nextMonthISO = d.toISOString().split('T')[0];

            tr.innerHTML = `
            <td class="ps-3 text-start"><select class="form-select form-select-sm prod-select">${prodOpts}</select></td>
            <td><input type="date" class="form-control form-control-sm fecha-venc" value="${nextMonthISO}"></td>
            <td><input type="number" step="0.1" class="form-control form-control-sm fw-bold bg-warning-subtle text-warning-emphasis input-cajas" placeholder="0"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm fw-bold bg-success-subtle text-success input-peso" placeholder="0.00"></td>
            <td class="text-center"><div class="form-check form-switch" style="min-height:auto; margin-bottom:0;"><input class="form-check-input input-frozen mx-auto" type="checkbox" role="switch" checked></div></td>
            <td class="text-center"><button class="btn btn-sm btn-link text-danger btn-del"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);

            const sel = tr.querySelector('.prod-select');
            const box = tr.querySelector('.input-cajas');
            const wgt = tr.querySelector('.input-peso');
            const del = tr.querySelector('.btn-del');

            // Si no hay cliente seleccionado, deshabilitar select de producto
            if (!idClienteActual) sel.disabled = true;

            sel.onchange = () => {
                const opt = sel.options[sel.selectedIndex];
                tr.dataset.nominal = opt.dataset.weight || 0;
                calcRow(tr);
            };
            box.oninput = () => calcRow(tr);
            wgt.oninput = updateTotal;
            del.onclick = () => { if (tbody.children.length > 0) tr.remove(); updateTotal(); };
        }

        function calcRow(tr) {
            const nom = parseFloat(tr.dataset.nominal) || 0;
            const boxes = parseFloat(tr.querySelector('.input-cajas').value) || 0;
            if (nom > 0 && boxes > 0) tr.querySelector('.input-peso').value = (boxes * nom).toFixed(2);
            updateTotal();
        }

        function updateTotal() {
            let c = 0, p = 0;
            document.querySelectorAll('#entrada-tbody tr').forEach(tr => {
                c += parseFloat(tr.querySelector('.input-cajas').value) || 0;
                p += parseFloat(tr.querySelector('.input-peso').value) || 0;
            });
            document.getElementById('entrada-total-cajas').textContent = c.toFixed(1);
            document.getElementById('entrada-total-peso').textContent = p.toFixed(2) + ' Kg';
        }

        // --- TOAST HELPER ---
        function showToast(message, type = 'primary') {
            const container = document.getElementById('toast-container');
            const id = 'toast-' + Math.random().toString(36).substr(2, 9);
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle');
            const color = type === 'success' ? 'text-success' : (type === 'danger' ? 'text-danger' : 'text-primary');

            const html = `
        <div id="${id}" class="toast align-items-center border-0 shadow-lg mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fw-bold ${color}">
                    <i class="fas ${icon} me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>`;

            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            container.appendChild(wrapper.firstElementChild);

            const el = document.getElementById(id);
            const toast = new bootstrap.Toast(el, { delay: 4000 });
            toast.show();

            el.addEventListener('hidden.bs.toast', () => el.remove());
        }

        async function saveEntrada() {
            const idCli = selectCli.value;
            if (!idCli) return showToast("Seleccione Cliente", 'danger');

            const rows = [];
            document.querySelectorAll('#entrada-tbody tr').forEach(tr => {
                const pid = tr.querySelector('.prod-select').value;
                const c = parseFloat(tr.querySelector('.input-cajas').value);
                const p = parseFloat(tr.querySelector('.input-peso').value);
                const v = tr.querySelector('.fecha-venc').value;
                const f = tr.querySelector('.input-frozen').checked; // Item Level
                if (pid && c > 0 && p > 0) rows.push({ idProducto: pid, cantidadCajas: c, pesoKg: p, fechaVencimiento: v, lote: 0, esCongelado: f });
            });
            const isUpdate = btnSave.dataset.updateId;
            const method = isUpdate ? 'apiActualizarMovimiento' : 'apiGuardarMovimiento';

            const pay = {
                id: isUpdate || null,
                tipo: 'ENTRADA',
                idCliente: idCli,
                nombreCliente: selectCli.options[selectCli.selectedIndex].text,
                docReferencia: document.getElementById('entrada-doc').value,
                fecha: document.getElementById('entrada-fecha').value,
                totalCajas: parseFloat(document.getElementById('entrada-total-cajas').textContent),
                totalPeso: parseFloat(document.getElementById('entrada-total-peso').textContent.replace(' Kg', '')),
                // esCongelado Removed from Header
                productos: rows
            };

            if (rows.length === 0) return showToast("Ingrese items validos", 'danger');

            btnSave.disabled = true;
            const originalText = btnSave.innerHTML;
            btnSave.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
            showToast("Procesando entrada...", 'primary');

            try {
                const res = await serverCall(method, pay);
                btnSave.disabled = false; btnSave.innerHTML = originalText;

                if (res.success) {
                    showToast(`Operación exitosa`, 'success');
                    if (res.pdfUrl && !res.pdfUrl.startsWith('Error')) window.open(res.pdfUrl, '_blank');

                    if (isUpdate) {
                        // Reset and go back
                        GLOBAL_STATE.tempEditData = null;
                        loadView('view-movements');
                    } else {
                        tbody.innerHTML = ''; addItemRow();
                        document.getElementById('entrada-doc').value = ''; updateTotal();
                        if (document.getElementById('entrada-congelado')) document.getElementById('entrada-congelado').checked = true;
                    }
                } else {
                    showToast("Error: " + res.error, 'danger');
                }
            } catch (err) {
                btnSave.disabled = false; btnSave.innerHTML = originalText;
                showToast("Error del servidor: " + err.message, 'danger');
            }
        }
    }

    // --- VISTA: SALIDA ---
    // --- VISTA: SALIDA ---
    async function initSalida() {
        const selectCli = document.getElementById('salida-cliente');
        const invBody = document.getElementById('salida-inv-body');
        const cartItems = document.getElementById('salida-cart-items');
        const cartEmpty = document.getElementById('salida-cart-empty');
        const btnSave = document.getElementById('salida-btn-save'); // DEFINED HERE
        let CART = [];

        // --- NEW: Event Listener for Editing ---
        // --- NEW: Event Listener for Editing ---
        if (!window.salidaListenerAdded) {
            document.addEventListener('LoadCartData', (e) => {
                const data = e.detail; // { items: [], id: '' }
                // Need to access the CURRENT CART instance?
                // Problem: CART is local to initSalida closure.
                // If we make the listener global/once, it captures the FIRST CART instance (which is dead).
                // SOLUTION: The listener MUST be re-added every time, BUT we must remove old ones.
                // OR: Discard the custom event approach and call a global function that initSalida exposes?
                // Better: initSalida attaches a specific handler to a global variable, and setupEditSalidaMode calls that global variable.
            });
        }

        // RE-DESIGN:
        // Expose a function to load data into THIS specific instance.
        window.loadSalidaCartData = (items, id) => {
            CART = [];
            items.forEach(i => {
                const pDef = GLOBAL_STATE.productos.find(p => String(p.id) === String(i.idProducto));
                const nombre = pDef ? pDef.nombre : i.idProducto;
                const nominal = pDef ? pDef.pesoNominal : 0;

                CART.push({
                    idProducto: i.idProducto,
                    lote: i.lote,
                    nombreProducto: nombre,
                    salidaCajas: Math.abs(i.cantidadCajas), // FIX NEGATIVE
                    salidaKg: Math.abs(i.pesoKg),           // FIX NEGATIVE
                    maxPeso: 99999,
                    nominal: nominal
                });
            });
            renderCart();
            btnSave.dataset.updateId = id;
        };


        // Init Fecha
        const dateInput = document.getElementById('salida-fecha');
        if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];

        try {
            const [clientes, productos] = await Promise.all([
                serverCall('apiGetClientes'),
                serverCall('apiGetProductos')
            ]);
            let opts = '<option value="" disabled selected>Seleccione...</option>';
            clientes.forEach(x => opts += `<option value="${x.id}">${x.nombre}</option>`);
            selectCli.innerHTML = opts;
            GLOBAL_STATE.productos = productos;

            // (Edit check moved to end of function)
        } catch (e) {
            alert("Error inicializando módulo de salida: " + e.message);
        }

        selectCli.onchange = async () => {
            try {
                const inv = await serverCall('apiGetInventarioCliente', selectCli.value);
                invBody.innerHTML = '';
                CART = []; renderCart();
                if (!inv || inv.length === 0) { document.getElementById('salida-empty').classList.remove('d-none'); return; }

                document.getElementById('salida-inv-container').classList.remove('d-none');

                // CHECK EDIT MODE
                if (GLOBAL_STATE.tempEditData && GLOBAL_STATE.tempEditData.header.tipo === 'SALIDA') {
                    // Call setup ONLY if we are not already setting it up.
                    // But here we are inside onchange.
                    // setupEditSalidaMode triggers onchange.
                    // So we should probably let setupEditSalidaMode handle the flow.
                }

                const groups = {};
                inv.forEach(i => { if (!groups[i.idProducto]) groups[i.idProducto] = { name: i.nombreProducto, items: [] }; groups[i.idProducto].items.push(i); });

                let html = '';
                for (const [pid, g] of Object.entries(groups)) {
                    html += `<tr class="table-secondary"><td colspan="4" class="fw-bold ps-3"><i class="fas fa-box me-1"></i> ${g.name}</td></tr>`;
                    g.items.forEach(i => {
                        const json = JSON.stringify(i).replace(/"/g, '&quot;');
                        html += `<tr>
                        <td class="ps-4 font-monospace text-muted">Lote: ${i.lote}</td>
                        <td class="text-end">${i.cajas.toFixed(1)}</td>
                        <td class="text-end fw-bold text-success">${i.peso.toFixed(2)}</td>
                        <td class="text-end pe-3"><button class="btn btn-sm btn-outline-primary py-0 px-2 btn-add" data-item="${json}"><i class="fas fa-plus"></i></button></td>
                     </tr>`;
                    });
                }
                invBody.innerHTML = html;
                document.querySelectorAll('.btn-add').forEach(b => b.onclick = () => addToCart(JSON.parse(b.dataset.item)));
            } catch (err) {
                alert("Error cargando inventario: " + err.message);
            }
        };

        function addToCart(item) {
            if (CART.find(x => x.lote === item.lote && x.idProducto === item.idProducto)) return;
            const pDef = GLOBAL_STATE.productos.find(p => p.id === item.idProducto);
            CART.push({ ...item, salidaCajas: 0, salidaKg: 0, maxPeso: item.peso, nominal: pDef ? pDef.pesoNominal : 0 });
            renderCart();
        }

        function renderCart() {
            if (CART.length === 0) { cartItems.innerHTML = ''; cartEmpty.classList.remove('d-none'); }
            else cartEmpty.classList.add('d-none');

            let html = '';
            CART.forEach((item, idx) => {
                html += `<div class="card mb-2 shadow-sm border bg-light"><div class="card-body p-2">
                 <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="small text-truncate w-75" title="${item.nombreProducto}">${item.nombreProducto}</strong>
                    <button class="btn-close btn-close-sm btn-rem" data-idx="${idx}"></button>
                 </div>
                 <div class="row g-2">
                    <div class="col-5">
                        <label class="form-label text-xs text-muted mb-0">Cajas</label>
                        <input type="number" class="form-control form-control-sm inp-cajas" data-idx="${idx}" value="${item.salidaCajas}">
                    </div>
                    <div class="col-7">
                        <label class="form-label text-xs text-muted mb-0">Peso (Max ${item.maxPeso.toFixed(0)})</label>
                        <input type="number" class="form-control form-control-sm fw-bold text-dark inp-peso" data-idx="${idx}" value="${item.salidaKg}">
                    </div>
                 </div></div></div>`;
            });
            cartItems.innerHTML = html;
            updateTotal();

            document.querySelectorAll('.btn-rem').forEach(b => { b.onclick = () => { CART.splice(b.dataset.idx, 1); renderCart(); } });

            const bindInputs = () => {
                document.querySelectorAll('.inp-cajas').forEach(inp => {
                    inp.oninput = (e) => {
                        const i = CART[e.target.dataset.idx];
                        i.salidaCajas = parseFloat(e.target.value) || 0;
                        if (i.nominal > 0) {
                            let w = i.salidaCajas * i.nominal;
                            i.salidaKg = (w > i.maxPeso) ? parseFloat(i.maxPeso.toFixed(2)) : parseFloat(w.toFixed(2));
                        }
                        renderCart();
                        const newInps = document.querySelectorAll('.inp-cajas');
                        if (newInps[e.target.dataset.idx]) {
                            newInps[e.target.dataset.idx].focus();
                            newInps[e.target.dataset.idx].value = e.target.value;
                        }
                    };
                });
                document.querySelectorAll('.inp-peso').forEach(inp => {
                    inp.onchange = (e) => { CART[e.target.dataset.idx].salidaKg = parseFloat(e.target.value) || 0; updateTotal(); };
                });
            };
            bindInputs();
        }

        function updateTotal() {
            const tot = CART.reduce((a, b) => a + (b.salidaKg || 0), 0);
            document.getElementById('salida-total-peso').textContent = tot.toFixed(2);
        }

        btnSave.onclick = async () => {
            if (CART.length === 0) return alert("El carrito está vacío.");

            const isUpdate = btnSave.dataset.updateId;
            const method = isUpdate ? 'apiActualizarMovimiento' : 'apiGuardarMovimiento';

            const pay = {
                id: isUpdate || null,
                tipo: 'SALIDA',
                idCliente: selectCli.value,
                nombreCliente: selectCli.options[selectCli.selectedIndex].text,
                docReferencia: document.getElementById('salida-doc').value || 'Despacho',
                fecha: document.getElementById('salida-fecha').value,
                totalCajas: CART.reduce((a, b) => a + b.salidaCajas, 0),
                totalPeso: CART.reduce((a, b) => a + b.salidaKg, 0),
                productos: CART.map(i => ({ idProducto: i.idProducto, lote: i.lote, cantidadCajas: i.salidaCajas * -1, pesoKg: i.salidaKg * -1 }))
            };

            // Check totals
            if (pay.totalPeso <= 0) return alert("El peso total debe ser mayor a 0");

            btnSave.disabled = true;
            btnSave.textContent = isUpdate ? 'Actualizando...' : 'Procesando...';

            try {
                const res = await serverCall(method, pay);
                btnSave.disabled = false;
                btnSave.textContent = isUpdate ? 'Actualizar Despacho' : 'Confirmar Despacho';

                if (res.success) {
                    alert(res.message || "Operación exitosa.");
                    if (res.pdfUrl && !res.pdfUrl.startsWith('Error')) window.open(res.pdfUrl, '_blank');

                    if (isUpdate) {
                        // Reset UI after update
                        delete btnSave.dataset.updateId;
                        btnSave.textContent = 'Confirmar Despacho';
                        btnSave.classList.replace('btn-primary', 'btn-warning');
                        // Return to history logic? Or just reset form
                        selectCli.value = '';
                        CART = []; renderCart();
                        document.getElementById('view-movements-link').click();
                    } else {
                        selectCli.onchange();
                        document.getElementById('salida-doc').value = '';
                    }
                } else alert(res.error);
            } catch (err) {
                btnSave.disabled = false;
                btnSave.textContent = isUpdate ? 'Actualizar Despacho' : 'Confirmar Despacho';
                alert("Error procesando salida: " + err.message);
            }
        };

        // CHECK EDIT MODE STARTUP (Now that listeners are ready)
        if (GLOBAL_STATE.tempEditData && GLOBAL_STATE.tempEditData.header.tipo === 'SALIDA') {
            setupEditSalidaMode(GLOBAL_STATE.tempEditData);
        }

    }

    // --- VISTA: MOVIMIENTOS ---
    async function initMovimientos() {
        const search = document.getElementById('mov-search');
        const tbody = document.getElementById('mov-table-body');
        const loader = document.getElementById('mov-loading');
        const empty = document.getElementById('mov-empty');
        const table = tbody.closest('.card'); // Container

        let allMovs = [];

        function render(list) {
            if (!list || list.length === 0) {
                tbody.innerHTML = '';
                table.classList.add('d-none');
                empty.classList.remove('d-none');
                return;
            }
            empty.classList.add('d-none');
            table.classList.remove('d-none');

            let html = '';
            list.forEach(m => {
                const badge = m.tipo === 'ENTRADA' ? 'bg-success-subtle text-success' : 'bg-warning-subtle text-warning text-dark';
                html += `<tr>
                <td class="ps-4 fw-bold font-monospace text-primary small">${m.id}<div class="text-muted fw-normal" style="font-size:0.7em">${m.ref || 'N/A'}</div></td>
                <td><div class="fw-bold">${new Date(m.fecha).toLocaleDateString()}</div><small class="text-muted">${new Date(m.fecha).toLocaleTimeString()}</small></td>
                <td>${m.nombreCliente}</td>
                <td><span class="badge ${badge}">${m.tipo}</span></td>
                <td class="text-end fw-bold">${m.totalPeso}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-icon btn-light rounded-circle text-primary me-1 btn-edit-mov" data-id="${m.id}" title="Editar Movimiento">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <a href="${m.url}" target="_blank" class="btn btn-sm btn-icon btn-light rounded-circle text-secondary" title="Ver PDF">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                </td>
              </tr>`;
            });
            tbody.innerHTML = html;
            // Bind edit buttons
            document.querySelectorAll('.btn-edit-mov').forEach(b => {
                b.onclick = () => loadEditMovimiento(b.dataset.id);
            });
        }

        loader.classList.remove('d-none');
        table.classList.add('d-none');
        empty.classList.add('d-none');

        loader.classList.remove('d-none');
        table.classList.add('d-none');
        empty.classList.add('d-none');

        try {
            const res = await serverCall('apiGetUltimosMovimientos');
            loader.classList.add('d-none');
            allMovs = res;
            render(allMovs);
        } catch (e) {
            alert("Error cargando historial: " + e.message);
            loader.classList.add('d-none');
        }

        document.getElementById('mov-btn-refresh').onclick = initMovimientos;

        search.oninput = () => {
            const q = search.value.toLowerCase();
            const filtered = allMovs.filter(m =>
                m.id.toLowerCase().includes(q) ||
                m.nombreCliente.toLowerCase().includes(q) ||
                (m.ref && m.ref.toLowerCase().includes(q))
            );
            render(filtered);
        };
    }

    // --- CARGAR EDICIÓN DE MOVIMIENTO ---
    async function loadEditMovimiento(idMovimiento) {
        const loader = document.getElementById('mov-loading');
        loader.classList.remove('d-none'); // This works because we are in view-movements

        try {
            const data = await serverCall('apiGetMovimientoDetalle', idMovimiento);

            // STORE DATA FOR THE NEXT VIEW TO CONSUME
            GLOBAL_STATE.tempEditData = data;

            // NAVIGATE
            if (data.header.tipo === 'ENTRADA') {
                await loadView('view-entrada');
            } else {
                await loadView('view-salida');
            }

            // Loader handling is tricky because view changed.
            // But loadView handles its own spinner on #app.
        } catch (e) {
            if (loader) loader.classList.add('d-none');
            alert("Error cargando movimiento: " + e.message);
        }
    }

    function loadEditEntrada(data) {
        // 1. Switch View Logic REMOVED (Handled by loadView)
        // document.querySelectorAll('.view-section').forEach...
        // document.getElementById('view-entrada').classList.remove('d-none');
        // document.querySelectorAll('.nav-link').forEach...
        // document.querySelector('[onclick*="view-entrada"]').classList.add('active');

        // 2. Populate Header
        const selCli = document.getElementById('entrada-cliente');
        selCli.value = data.header.idCliente;
        document.getElementById('entrada-fecha').value = data.header.fecha;

        // 3. Populate Items
        const tbody = document.getElementById('entrada-tbody');
        tbody.innerHTML = '';

        // Función helper para agregar fila con datos
        data.items.forEach(item => {
            const tr = document.createElement('tr');
            // Reconstruir opciones de producto (Necesitamos la lista GLOBAL_STATE.productos)
            let prodOpts = '';
            const prodsCliente = GLOBAL_STATE.productos.filter(p => String(p.idCliente) === String(data.header.idCliente));
            prodsCliente.forEach(p => {
                const sel = String(p.id) === String(item.idProducto) ? 'selected' : '';
                prodOpts += `<option value="${p.id}" data-weight="${p.pesoNominal}" ${sel}>${p.nombre} (${p.empaque})</option>`;
            });

            tr.innerHTML = `
                <td><select class="form-select form-select-sm inp-prod" required>${prodOpts}</select></td>
                <td><input type="number" class="form-control form-control-sm inp-lote" value="${item.lote}" readonly title="Lote no editable"></td>
                <td><input type="date" class="form-control form-control-sm inp-venc" value="${item.fechaVencimiento}"></td>
                <td><input type="number" class="form-control form-control-sm inp-qty" value="${item.cantidadCajas}" placeholder="0.0"></td>
                <td><div class="input-group input-group-sm"><input type="number" class="form-control fw-bold inp-peso" value="${item.pesoKg}" placeholder="0.00"><span class="input-group-text">kg</span></div></td>
                <td class="text-center"><div class="form-check form-switch d-flex justify-content-center"><input class="form-check-input inp-frozen" type="checkbox" ${item.esCongelado !== false ? 'checked' : ''}></div></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger border-0 btn-del"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);

            // Bind eventos fila (igual que en addItemRow)
            const selProd = tr.querySelector('.inp-prod');
            const inpQty = tr.querySelector('.inp-qty');
            const inpPeso = tr.querySelector('.inp-peso');
            const btnDel = tr.querySelector('.btn-del');

            selProd.onchange = () => {
                const opt = selProd.options[selProd.selectedIndex];
                const nom = parseFloat(opt.dataset.weight) || 0;
                tr.dataset.weight = nom;
                if (inpQty.value) inpPeso.value = (parseFloat(inpQty.value) * nom).toFixed(2);
            };
            inpQty.oninput = () => {
                const nom = parseFloat(tr.dataset.weight) || 0;
                if (nom > 0) inpPeso.value = (parseFloat(inpQty.value) * nom).toFixed(2);
            };
            btnDel.onclick = () => tr.remove();
        });

        // 4. Change Save Button
        const btnSave = document.getElementById('entrada-btn-save');

        // Crear botón Cancelar si no existe
        let btnCancel = document.getElementById('entrada-btn-cancel');
        if (!btnCancel) {
            btnCancel = document.createElement('button');
            btnCancel.id = 'entrada-btn-cancel';
            btnCancel.className = 'btn btn-secondary ms-2';
            btnCancel.innerHTML = 'Cancelar Edición';
            btnSave.parentNode.appendChild(btnCancel);
        }
        btnCancel.classList.remove('d-none');
        btnCancel.onclick = () => {
            resetEntradaForm(); // Necesitas definir esto o recargar
            btnSave.onclick = saveEntrada; // Restaurar función original
            btnSave.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Entrada';
            btnSave.classList.replace('btn-primary', 'btn-success');
            btnSave.disabled = false; // Ensure enabled
            btnCancel.classList.add('d-none');
            const link = document.getElementById('view-movements-link');
            if (link) link.click(); // Volver a historial
            else loadView('view-movements'); // Fallback if link not found
        };

        btnSave.innerHTML = '<i class="fas fa-sync me-2"></i>Actualizar Movimiento';
        btnSave.classList.replace('btn-success', 'btn-primary');

        btnSave.onclick = async () => {
            // Lógica de Actualización
            const rows = [...tbody.querySelectorAll('tr')];
            if (rows.length === 0) return alert("Debe haber al menos un producto.");

            const productos = [];
            for (let tr of rows) {
                const idProd = tr.querySelector('.inp-prod').value;
                const lote = tr.querySelector('.inp-lote').value;
                const venc = tr.querySelector('.inp-venc').value;
                const cajas = parseFloat(tr.querySelector('.inp-qty').value);
                const peso = parseFloat(tr.querySelector('.inp-peso').value);
                const frozen = tr.querySelector('.inp-frozen').checked;

                if (!idProd || !cajas || !peso) return alert("Complete todos los campos de los productos.");
                productos.push({ idProducto: idProd, lote: lote, fechaVencimiento: venc, cantidadCajas: cajas, pesoKg: peso, esCongelado: frozen });
            }

            const payload = {
                id: data.header.id, // ID ORIGINAL
                tipo: 'ENTRADA',
                idCliente: selCli.value, // Aunque no se debería cambiar cliente
                docReferencia: 'Actualización', // O input si hubiera
                fecha: document.getElementById('entrada-fecha').value,
                totalCajas: productos.reduce((a, b) => a + b.cantidadCajas, 0),
                totalPeso: productos.reduce((a, b) => a + b.pesoKg, 0),
                productos: productos
            };

            btnSave.disabled = true;
            try {
                const res = await serverCall('apiActualizarMovimiento', payload);
                if (res.success) {
                    alert("Movimiento actualizado correctamente.");
                    if (res.pdfUrl && !res.pdfUrl.startsWith('Error')) window.open(res.pdfUrl, '_blank');
                    btnCancel.click(); // Reset UI
                } else {
                    alert("Error: " + res.error);
                }
            } catch (err) {
                alert("Error de red: " + err.message);
                console.error(err);
            } finally {
                btnSave.disabled = false;
            }
        };

        function resetEntradaForm() {
            document.getElementById('entrada-form').reset();
            document.getElementById('entrada-tbody').innerHTML = '';
            // Restore default date
            document.getElementById('entrada-fecha').value = new Date().toISOString().split('T')[0];
        }
    }

    function loadEditSalida(data) {
        // 1. Switch View Logic REMOVED (Handled by loadView)
        // document.querySelectorAll('.view-section').forEach...
        // document.getElementById('view-salida').classList.remove('d-none');
        // document.querySelectorAll('.nav-link').forEach...
        // document.querySelector('[onclick*="view-salida"]').classList.add('active');

        // 2. Populate Header
        const selCli = document.getElementById('salida-cliente');
        selCli.value = data.header.idCliente;

        // Disparar evento para que initSalida cargue inventario
        // Pero initSalida tiene un onchange que hace serverCall.
        // Simularemos el cambio
        selCli.dispatchEvent(new Event('change'));

        setTimeout(() => {
            document.getElementById('salida-fecha').value = data.header.fecha;
            document.getElementById('salida-doc').value = data.header.docReferencia;

            // Despachar evento para llenar carrito
            const event = new CustomEvent('LoadCartData', { detail: { items: data.items, id: data.header.id } });
            document.dispatchEvent(event);
        }, 1500); // 1.5s delay
    }

    // --- VISTA: BILLING (UPDATED) ---
    async function initBilling() {
        const selCli = document.getElementById('bill-cliente');
        const dateIn = document.getElementById('bill-inicio');
        const dateOut = document.getElementById('bill-fin');
        const btnCalc = document.getElementById('bill-btn-calc');

        const btnPdfBrief = document.getElementById('bill-btn-pdf-brief');
        const btnPdfDetail = document.getElementById('bill-btn-pdf-detail');

        const loader = document.getElementById('bill-loading');
        const results = document.getElementById('bill-results');

        let currentResult = null; // Store for PDF generation

        try {
            const c = await serverCall('apiGetClientes');
            let opts = '<option value="" disabled selected>Seleccione...</option>';
            c.forEach(x => opts += `<option value="${x.id}">${x.nombre}</option>`);
            selCli.innerHTML = opts;
        } catch (e) {
            alert("Error cargando clientes: " + e.message);
        }

        const now = new Date();
        dateOut.valueAsDate = now;
        dateIn.valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);

        btnCalc.onclick = async () => {
            if (!selCli.value) return alert("Seleccione Cliente");
            results.classList.add('d-none');
            loader.classList.remove('d-none');
            btnCalc.disabled = true;

            try {
                // Call specific Billing API - CORRECTION: Name is apiCalcularFacturacion
                const res = await serverCall('apiCalcularFacturacion', selCli.value, dateIn.value, dateOut.value);
                loader.classList.add('d-none');
                btnCalc.disabled = false;
                if (!res.success) return alert("Error/Sin datos: " + (res.error || ""));

                currentResult = res; // Save for PDF
                const clienteNombre = selCli.options[selCli.selectedIndex].text;
                currentResult.cliente = { id: selCli.value, nombre: clienteNombre }; // Add context
                currentResult.periodo = { inicio: dateIn.value, fin: dateOut.value };
                currentResult.metricas = {
                    dias: res.dias,
                    costoBase: res.costoBase,
                    costoExcedente: res.costoExcedente,
                    totalPagar: res.totalPagar
                };

                document.getElementById('bill-kpi-dias').textContent = res.dias;
                document.getElementById('bill-kpi-base').textContent = '$' + res.costoBase.toLocaleString();
                document.getElementById('bill-kpi-exce').textContent = '$' + res.costoExcedente.toLocaleString();

                // Calc Total Recargos
                const totalRecargos = res.detalleDiario.reduce((sum, d) => sum + (d.costoRecargo || 0), 0);
                document.getElementById('bill-kpi-recargo').textContent = '$' + totalRecargos.toLocaleString();

                document.getElementById('bill-kpi-total').textContent = '$' + res.totalPagar.toLocaleString();

                const alertElem = document.getElementById('bill-alert-type');
                if (res.tipoPago === 'PREPAGO') {
                    alertElem.className = 'alert mb-0 alert-success';
                    document.getElementById('bill-type-text').textContent = 'Prepago';
                    document.getElementById('bill-type-desc').textContent = 'Base incluye posiciones contratadas.';
                } else {
                    alertElem.className = 'alert mb-0 alert-warning';
                    document.getElementById('bill-type-text').textContent = 'Postpago';
                    document.getElementById('bill-type-desc').textContent = 'Pago total al retiro.';
                }

                const tbody = document.getElementById('bill-table-body');
                let html = '';
                res.detalleDiario.forEach(d => {
                    const trClass = d.excedente > 0 ? 'table-warning' : '';
                    const diff = d.excedenteKg > 0 ? `<small>${d.excedenteKg.toFixed(1)} Kg</small> <span class="text-muted">/</span> $${d.costoExcDia.toLocaleString()}` : '-';
                    html += `<tr class="${trClass}">
                    <td class="ps-4 font-monospace">${new Date(d.fecha).toLocaleDateString()}</td>
                    <td class="text-end">${d.stockKg.toLocaleString()}</td>
                    <td class="text-end fw-bold">${d.posUsadas.toFixed(2)}</td>
                    <td class="text-end text-muted">${d.posContratadas}</td>
                    <td class="text-end fw-bold ${d.excedenteKg > 0 ? 'text-danger' : 'text-success'}">${diff}</td>
                    <td class="text-end text-secondary fw-bold">${d.costoRecargo > 0 ? '$' + d.costoRecargo.toLocaleString() : '-'}</td>
                    <td class="text-end pe-4 fw-bold text-dark">$${d.costoDia.toLocaleString()}</td>
                  </tr>`;
                });
                tbody.innerHTML = html;
                results.classList.remove('d-none');
            } catch (err) {
                loader.classList.add('d-none');
                btnCalc.disabled = false;
                alert("Error de cálculo: " + err.message);
            }
        };

        // PDF Handlers
        if (btnPdfBrief) btnPdfBrief.onclick = async () => {
            if (!currentResult) return;
            const btn = btnPdfBrief;
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

            try {
                const res = await serverCall('apiGenerarPDFFacturaResumen', currentResult);
                btn.disabled = false; btn.innerHTML = originalText;
                if (res.success && res.pdfUrl) window.open(res.pdfUrl, '_blank');
                else alert("Error PDF: " + (res.error || "Desconocido"));
            } catch (err) {
                btn.disabled = false; btn.innerHTML = originalText;
                alert("Error generando PDF: " + err.message);
            }
        };

        if (btnPdfDetail) btnPdfDetail.onclick = async () => {
            if (!currentResult) return;
            const btn = btnPdfDetail;
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

            try {
                const res = await serverCall('apiGenerarPDFFacturaDetallada', currentResult);
                btn.disabled = false; btn.innerHTML = originalText;
                if (res.success && res.pdfUrl) window.open(res.pdfUrl, '_blank');
                else alert("Error PDF: " + (res.error || "Desconocido"));
            } catch (err) {
                btn.disabled = false; btn.innerHTML = originalText;
                alert("Error generando PDF: " + err.message);
            }
        };
    }

    // --- HELPERS PARA EDICIÓN (Global Scope) ---
    function setupEditEntradaMode(data) {
        const selCli = document.getElementById('entrada-cliente');
        const inpDate = document.getElementById('entrada-fecha');
        const inpDoc = document.getElementById('entrada-doc');
        const tbody = document.getElementById('entrada-tbody');
        const btnSave = document.getElementById('entrada-btn-save');

        // 1. Header
        selCli.value = data.header.idCliente;
        inpDate.value = data.header.fecha;
        if (inpDoc) inpDoc.value = data.header.docReferencia || '';

        // Restore Frozen State
        const chkFrozen = document.getElementById('entrada-congelado');
        if (chkFrozen) chkFrozen.checked = (data.header.esCongelado !== undefined && data.header.esCongelado !== null) ? data.header.esCongelado : true;

        // 2. Items
        tbody.innerHTML = '';
        data.items.forEach(item => {
            // Find nominal
            const pDef = GLOBAL_STATE.productos.find(p => String(p.id) === String(item.idProducto));
            const nom = pDef ? pDef.pesoNominal : 0;

            const tr = document.createElement('tr');
            let prodOpts = '';

            const prodsCliente = GLOBAL_STATE.productos.filter(p => String(p.idCliente) === String(data.header.idCliente));
            prodsCliente.forEach(p => {
                const sel = String(p.id) === String(item.idProducto) ? 'selected' : '';
                prodOpts += `<option value="${p.id}" data-weight="${p.pesoNominal}" ${sel}>${p.nombre} (${p.empaque})</option>`;
            });

            // Format date
            const venc = item.fechaVencimiento ? new Date(item.fechaVencimiento).toISOString().split('T')[0] : '';

            tr.innerHTML = `
            <td class="ps-3 text-start"><select class="form-select form-select-sm prod-select">${prodOpts}</select></td>
            <td><input type="date" class="form-control form-control-sm fecha-venc" value="${venc}"></td>
            <td><input type="number" step="0.1" class="form-control form-control-sm fw-bold bg-warning-subtle text-warning-emphasis input-cajas" placeholder="0" value="${item.cantidadCajas}"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm fw-bold bg-success-subtle text-success input-peso" placeholder="0.00" value="${item.pesoKg}"></td>
            <td class="text-center"><button class="btn btn-sm btn-link text-danger btn-del"><i class="fas fa-trash"></i></button></td>`;

            tbody.appendChild(tr);

            // Set nominal
            tr.dataset.nominal = nom;

            const sel = tr.querySelector('.prod-select');
            const box = tr.querySelector('.input-cajas');
            const wgt = tr.querySelector('.input-peso');
            const del = tr.querySelector('.btn-del');

            sel.onchange = () => {
                const opt = sel.options[sel.selectedIndex];
                tr.dataset.nominal = opt.dataset.weight || 0;
                const bs = parseFloat(box.value) || 0;
                const n = parseFloat(tr.dataset.nominal) || 0;
                if (n > 0 && bs > 0) wgt.value = (bs * n).toFixed(2);
                updateTotalsEntrada();
            };
            box.oninput = () => {
                const n = parseFloat(tr.dataset.nominal) || 0;
                const bs = parseFloat(box.value) || 0;
                if (n > 0 && bs > 0) wgt.value = (bs * n).toFixed(2);
                updateTotalsEntrada();
            };
            wgt.oninput = updateTotalsEntrada;
            del.onclick = () => { tr.remove(); updateTotalsEntrada(); };
        });

        // 3. Update UI
        btnSave.innerHTML = '<i class="fas fa-sync me-2"></i>Actualizar Entrada';
        btnSave.classList.replace('btn-success', 'btn-primary');
        btnSave.dataset.updateId = data.header.id;

        let btnCancel = document.getElementById('entrada-btn-cancel');
        if (btnCancel) {
            btnCancel.classList.remove('d-none');
            btnCancel.onclick = () => {
                GLOBAL_STATE.tempEditData = null;
                loadView('view-entrada');
            };
        }
        updateTotalsEntrada();
    }

    function updateTotalsEntrada() {
        let c = 0, p = 0;
        document.querySelectorAll('#entrada-tbody tr').forEach(tr => {
            c += parseFloat(tr.querySelector('.input-cajas').value) || 0;
            p += parseFloat(tr.querySelector('.input-peso').value) || 0;
        });
        const tc = document.getElementById('entrada-total-cajas');
        const tp = document.getElementById('entrada-total-peso');
        if (tc) tc.textContent = c.toFixed(1);
        if (tp) tp.textContent = p.toFixed(2) + ' Kg';
    }

    function setupEditSalidaMode(data) {
        const selCli = document.getElementById('salida-cliente');
        const btnSave = document.getElementById('salida-btn-save');

        selCli.value = data.header.idCliente;
        // Trigger load inventory
        selCli.dispatchEvent(new Event('change'));

        const checkInv = setInterval(() => {
            const invBody = document.getElementById('salida-inv-body');
            const empty = document.getElementById('salida-empty');

            // Check if loaded (either items or empty message)
            if (invBody.children.length > 0 || (empty && !empty.classList.contains('d-none'))) {
                clearInterval(checkInv);

                // Populate Fields
                document.getElementById('salida-fecha').value = data.header.fecha;
                document.getElementById('salida-doc').value = data.header.docReferencia || '';

                // Dispatch - CALL GLOBAL FUNCTION DIRECTLY
                if (window.loadSalidaCartData) {
                    window.loadSalidaCartData(data.items, data.header.id);
                } else {
                    console.error("loadSalidaCartData not found!");
                }

                // Update Button
                btnSave.innerHTML = '<i class="fas fa-sync me-2"></i>Actualizar Despacho';
                btnSave.classList.replace('btn-warning', 'btn-primary');
            }
        }, 500);
    }
</script>